# RSVP专属链接分享功能实现计划

- [ ] 1. 数据库结构扩展
  - [ ] 1.1 扩展 RsvpContactEntity 表结构
    - 在 schema.prisma 中为 RsvpContactEntity 添加 form_config_id 字段
    - 添加 form_config_id 的唯一索引和关联关系
    - 在 RsvpFormConfigEntity 中添加 invitees 关联
    - 运行数据库迁移
    - _需求: 1.1, 1.2, 5.1_

  - [ ] 1.2 数据迁移和兼容性处理
    - 为现有 RsvpContactEntity 记录设置 form_config_id 为 null（普通联系人）
    - 确保向后兼容性
    - _需求: 5.1_

- [ ] 2. 后端API实现
  - [ ] 2.1 实现嘉宾管理接口
    - [ ] 2.1.1 createInvitee - 创建嘉宾
      - 实现输入验证（name必填，phone/email可选）
      - 处理手机号唯一性冲突
      - 设置 form_config_id 关联到表单配置
      - _需求: 1.4, 1.5_

    - [ ] 2.1.2 updateInvitee - 更新嘉宾信息
      - 实现更新逻辑
      - 处理唯一性约束
      - _需求: 6.1, 6.2_

    - [ ] 2.1.3 deleteInvitee - 删除嘉宾
      - 实现软删除逻辑
      - 保留历史提交记录
      - _需求: 6.3, 6.4_

    - [ ] 2.1.4 listInvitees - 查询嘉宾列表
      - 实现分页查询
      - 支持关键词搜索（姓名、手机、邮箱）
      - 按创建时间倒序排列
      - _需求: 1.6_

    - [ ] 2.1.5 getInviteeById - 根据ID查询嘉宾
      - 实现单个嘉宾查询
      - _需求: 2.3_

  - [ ] 2.2 实现提交记录查询接口
    - [ ] 2.2.1 getInviteeSubmissions - 获取嘉宾提交记录
      - 根据 contact_id 和 form_config_id 查询提交记录
      - 按 submission_group_id 分组，返回每组最新记录
      - _需求: 4.2, 4.3_

- [ ] 3. 配置面板扩展
  - [ ] 3.1 添加Tab切换功能
    - 在 RSVPConfigPanel 组件中添加"表单配置"和"分享设置"两个Tab
    - 实现Tab切换逻辑
    - 保持现有表单配置功能不变
    - _需求: 1.1_

  - [ ] 3.2 实现 ShareSettingsTab 组件
    - [ ] 3.2.1 创建 ShareSettingsTab 组件结构
      - 实现基础布局
      - 集成trpc查询
      - _需求: 1.1_

    - [ ] 3.2.2 实现公开链接分享区域
      - 显示公开链接（不包含嘉宾参数）
      - 实现复制链接功能
      - 实现二维码生成和展示
      - _需求: 3.1, 3.2, 3.3, 3.4_

    - [ ] 3.2.3 实现指定嘉宾分享区域
      - 显示嘉宾列表（姓名、手机、操作按钮）
      - 实现"添加嘉宾"按钮，跳转到嘉宾管理页面
      - 实现每个嘉宾的分享、编辑、删除操作
      - _需求: 1.2, 1.3, 2.1, 2.2_

    - [ ] 3.2.4 实现已邀请嘉宾提交记录区域
      - 显示嘉宾列表及其提交状态
      - 实现提交记录详情查看功能
      - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ] 4. 嘉宾管理页面实现
  - [ ] 4.1 创建嘉宾管理页面路由
    - 创建 packages/jiantie/app/mobile/rsvp-invitees/page.tsx
    - 实现页面基础结构
    - 从URL参数获取 form_config_id 和 works_id
      - _需求: 1.3_

  - [ ] 4.2 实现嘉宾列表组件
    - [ ] 4.2.1 InviteeList 组件
      - 显示嘉宾列表（姓名、手机、邮箱、状态）
      - 实现搜索和筛选功能
      - 实现分页加载
      - _需求: 1.6_

    - [ ] 4.2.2 InviteeItem 组件
      - 显示单个嘉宾信息
      - 实现编辑、删除、分享操作按钮
      - _需求: 6.1, 6.3, 2.1_

  - [ ] 4.3 实现嘉宾创建/编辑表单
    - [ ] 4.3.1 InviteeForm 组件
      - 实现姓名输入（必填）
      - 实现手机号输入（可选）
      - 实现邮箱输入（可选，邮箱格式验证）
      - 实现表单提交和验证
      - _需求: 1.4, 6.1, 6.2_

  - [ ] 4.4 实现批量操作功能
    - [ ] 4.4.1 实现批量选择
      - 添加复选框选择功能
      - _需求: 6.5_

    - [ ] 4.4.2 实现批量删除
      - 批量删除选中的嘉宾
      - 显示确认对话框
      - _需求: 6.5_

- [ ] 5. 分享页面实现
  - [ ] 5.1 创建分享页面路由
    - 创建 packages/jiantie/app/mobile/rsvp-share/page.tsx
    - 从URL参数获取 invitee_id 和 works_id
    - _需求: 2.1_

  - [ ] 5.2 实现专属链接生成逻辑
    - [ ] 5.2.1 获取嘉宾信息
      - 调用 getInviteeById API获取嘉宾详情
      - _需求: 2.3_

    - [ ] 5.2.2 生成专属链接
      - 构建URL: /viewer2/{worksId}?rsvp_invitee={name}&rsvp_phone={phone}
      - 使用URLSearchParams进行参数编码
      - _需求: 2.4, 2.6_

  - [ ] 5.3 实现分享功能
    - [ ] 5.3.1 集成分享组件
      - 复用现有的分享组件（微信、朋友圈、复制链接、二维码）
      - 传入生成的专属链接
      - _需求: 2.5_

- [ ] 6. RSVP组件增强
  - [ ] 6.1 支持URL参数读取
    - [ ] 6.1.1 解析URL参数
      - 从searchParams读取rsvp_invitee、rsvp_phone、rsvp_email
      - 判断是否为专属链接访问
      - _需求: 5.1_

    - [ ] 6.1.2 显示专属标题
      - 如果有rsvp_invitee参数，显示"诚邀 {嘉宾姓名}"
      - 否则显示配置的标题
      - _需求: 5.1_

  - [ ] 6.2 实现联系人自动匹配
    - [ ] 6.2.1 提交时匹配联系人
      - 如果URL中有rsvp_phone，查找或创建联系人
      - 设置form_config_id关联到表单
      - 在submission_data中添加\_inviteeInfo信息
      - _需求: 5.2, 5.4_

  - [ ] 6.3 实现"不是本人？"功能
    - [ ] 6.3.1 添加切换按钮
      - 当有inviteeName时显示"不是本人？"按钮
      - 点击后切换为公开访客模式
      - _需求: 5.3_

- [ ] 7. 类型定义和工具函数
  - [ ] 7.1 扩展类型定义
    - [ ] 7.1.1 在type.ts中添加类型
      - 添加Invitee相关类型定义
      - 添加分享链接相关类型
      - _需求: 所有前端需求_

  - [ ] 7.2 实现工具函数
    - [ ] 7.2.1 链接生成工具函数
      - 实现generateInviteeShareLink函数
      - 处理URL编码和参数构建
      - _需求: 2.4, 2.6_

    - [ ] 7.2.2 联系人匹配工具函数
      - 实现findOrCreateContact函数
      - 处理手机号匹配逻辑
      - _需求: 5.2, 5.4_

- [ ] 8. 错误处理和用户体验优化
  - [ ] 8.1 添加输入验证和错误提示
    - [ ] 8.1.1 表单验证
      - 嘉宾姓名必填验证
      - 邮箱格式验证
      - 手机号格式验证（可选）
      - _需求: 1.4, 6.1_

    - [ ] 8.1.2 错误提示
      - 友好的错误提示信息
      - 处理API错误响应
      - _需求: 所有需求_

  - [ ] 8.2 实现加载状态和空状态
    - [ ] 8.2.1 加载状态
      - 列表加载时显示loading
      - API调用时显示loading状态
      - _需求: 所有需求_

    - [ ] 8.2.2 空状态
      - 嘉宾列表为空时显示提示
      - 提交记录为空时显示提示
      - _需求: 1.2, 4.1_

  - [ ] 8.3 实现确认对话框
    - [ ] 8.3.1 删除确认
      - 删除嘉宾时显示确认对话框
      - 提示删除后已发送链接仍然有效
      - _需求: 6.3_

- [ ] 9. 测试和验证
  - [ ] 9.1 功能测试
    - [ ] 9.1.1 嘉宾管理测试
      - 创建、编辑、删除嘉宾功能
      - 批量操作功能
      - 搜索和筛选功能
      - _需求: 1, 6_

    - [ ] 9.1.2 分享功能测试
      - 生成专属链接
      - 各种分享方式（微信、朋友圈、复制、二维码）
      - _需求: 2_

    - [ ] 9.1.3 访问和提交测试
      - 通过专属链接访问RSVP表单
      - 显示专属标题
      - 提交时自动匹配联系人
      - _需求: 5_

  - [ ] 9.2 数据一致性测试
    - [ ] 9.2.1 联系人关联测试
      - 验证普通联系人和嘉宾的区别
      - 验证提交记录的正确关联
      - _需求: 5.4_

    - [ ] 9.2.2 删除影响测试
      - 验证删除嘉宾后链接仍可访问
      - 验证历史提交记录保留
      - _需求: 6.4_

- [ ] 10. 性能优化和代码重构
  - [ ] 10.1 性能优化
    - [ ] 10.1.1 列表优化
      - 实现虚拟滚动（如果列表很长）
      - 优化分页加载
      - _需求: 性能优化_

    - [ ] 10.1.2 查询优化
      - 使用React Query缓存
      - 优化API查询参数
      - _需求: 性能优化_

  - [ ] 10.2 代码重构
    - [ ] 10.2.1 组件拆分
      - 将大组件拆分为更小的可复用组件
      - 提取公共逻辑到hooks
      - _需求: 代码质量_

    - [ ] 10.2.2 类型安全
      - 完善TypeScript类型定义
      - 添加类型检查
      - _需求: 代码质量_
